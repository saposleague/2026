<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Teste iOS Push - Sapos League</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: white;
        }
        
        .container {
            max-width: 600px;
            margin: 0 auto;
        }
        
        h1 {
            font-size: 2em;
            margin-bottom: 10px;
            text-align: center;
        }
        
        .subtitle {
            text-align: center;
            opacity: 0.9;
            margin-bottom: 30px;
        }
        
        .card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .status {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            margin-bottom: 10px;
        }
        
        .status-label {
            font-weight: 600;
        }
        
        .status-value {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }
        
        .status-ok {
            background: #4caf50;
        }
        
        .status-error {
            background: #f44336;
        }
        
        .status-warning {
            background: #ff9800;
        }
        
        button {
            width: 100%;
            padding: 18px;
            font-size: 1.1em;
            font-weight: 600;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 10px;
        }
        
        .btn-primary {
            background: #4caf50;
            color: white;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .log-container {
            background: #1a1a1a;
            border-radius: 10px;
            padding: 15px;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        
        .log-entry {
            padding: 8px;
            margin-bottom: 5px;
            border-left: 3px solid;
            padding-left: 10px;
            word-wrap: break-word;
        }
        
        .log-info {
            border-left-color: #2196f3;
            color: #64b5f6;
        }
        
        .log-success {
            border-left-color: #4caf50;
            color: #81c784;
        }
        
        .log-error {
            border-left-color: #f44336;
            color: #e57373;
        }
        
        .log-warning {
            border-left-color: #ff9800;
            color: #ffb74d;
        }
        
        .info-box {
            background: rgba(33, 150, 243, 0.2);
            border-left: 4px solid #2196f3;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .info-box h3 {
            margin-bottom: 10px;
            font-size: 1.1em;
        }
        
        .info-box ul {
            margin-left: 20px;
        }
        
        .info-box li {
            margin-bottom: 5px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üçé Teste iOS Push</h1>
        <p class="subtitle">Diagn√≥stico completo de notifica√ß√µes</p>
        
        <div class="info-box">
            <h3>üìã Requisitos</h3>
            <ul>
                <li>iOS 16.4 ou superior</li>
                <li>PWA instalado na tela inicial</li>
                <li>N√£o funciona no Safari normal</li>
            </ul>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 15px;">üìä Status do Sistema</h2>
            <div id="status-container"></div>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 15px;">üéÆ A√ß√µes</h2>
            <button class="btn-primary" onclick="requestPermission()">
                üîî Solicitar Permiss√£o
            </button>
            <button class="btn-primary" onclick="registerPush()">
                üìù Registrar Push
            </button>
            <button class="btn-secondary" onclick="checkStatus()">
                üîç Verificar Status
            </button>
            <button class="btn-danger" onclick="unregisterPush()">
                üóëÔ∏è Desregistrar
            </button>
            <button class="btn-secondary" onclick="clearLogs()">
                üßπ Limpar Logs
            </button>
        </div>
        
        <div class="card">
            <h2 style="margin-bottom: 15px;">üìù Logs</h2>
            <div class="log-container" id="logs"></div>
        </div>
    </div>

    <script type="module">
        import { app } from './js/firebase-config.js';
        import { getFirestore, doc, setDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.8.1/firebase-firestore.js";

        const db = getFirestore(app);
        const VAPID_KEY = 'BOD3066MNR-gYBI6qquZcm2RxlN_ia_dQtADtGZGhan7SeuxcN6T8WwWB0sEnMpWpQ0aS0OkwoItlgYza1MkiRg';

        // Fun√ß√µes de log
        function log(message, type = 'info') {
            const logsDiv = document.getElementById('logs');
            const entry = document.createElement('div');
            entry.className = `log-entry log-${type}`;
            entry.textContent = `${new Date().toLocaleTimeString()} - ${message}`;
            logsDiv.appendChild(entry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        window.clearLogs = function() {
            document.getElementById('logs').innerHTML = '';
            log('Logs limpos', 'info');
        }

        // Verificar status
        async function updateStatus() {
            const container = document.getElementById('status-container');
            container.innerHTML = '';

            const checks = [
                {
                    label: 'iOS Detectado',
                    check: () => /iPad|iPhone|iPod/.test(navigator.userAgent),
                    value: (result) => result ? 'Sim' : 'N√£o'
                },
                {
                    label: 'Notifica√ß√µes',
                    check: () => 'Notification' in window,
                    value: (result) => result ? 'Suportado' : 'N√£o suportado'
                },
                {
                    label: 'Service Worker',
                    check: () => 'serviceWorker' in navigator,
                    value: (result) => result ? 'Suportado' : 'N√£o suportado'
                },
                {
                    label: 'Push API',
                    check: () => 'PushManager' in window,
                    value: (result) => result ? 'Suportado' : 'N√£o suportado'
                },
                {
                    label: 'Permiss√£o',
                    check: () => Notification.permission,
                    value: (result) => result
                },
                {
                    label: 'SW Registrado',
                    check: async () => {
                        const reg = await navigator.serviceWorker.getRegistration();
                        return !!reg;
                    },
                    value: (result) => result ? 'Sim' : 'N√£o'
                },
                {
                    label: 'Push Subscription',
                    check: async () => {
                        const reg = await navigator.serviceWorker.ready;
                        const sub = await reg.pushManager.getSubscription();
                        return !!sub;
                    },
                    value: (result) => result ? 'Ativa' : 'Inativa'
                }
            ];

            for (const check of checks) {
                const result = await check.check();
                const statusDiv = document.createElement('div');
                statusDiv.className = 'status';
                
                let statusClass = 'status-ok';
                if (check.label === 'Permiss√£o') {
                    if (result === 'granted') statusClass = 'status-ok';
                    else if (result === 'denied') statusClass = 'status-error';
                    else statusClass = 'status-warning';
                } else if (!result) {
                    statusClass = 'status-error';
                }
                
                statusDiv.innerHTML = `
                    <span class="status-label">${check.label}</span>
                    <span class="status-value ${statusClass}">${check.value(result)}</span>
                `;
                container.appendChild(statusDiv);
            }
        }

        window.checkStatus = updateStatus;

        // Solicitar permiss√£o
        window.requestPermission = async function() {
            try {
                log('Solicitando permiss√£o...', 'info');
                
                if (!('Notification' in window)) {
                    log('Notifica√ß√µes n√£o suportadas', 'error');
                    return;
                }

                if (Notification.permission === 'granted') {
                    log('Permiss√£o j√° concedida', 'success');
                    await updateStatus();
                    return;
                }

                const permission = await Notification.requestPermission();
                log(`Permiss√£o: ${permission}`, permission === 'granted' ? 'success' : 'error');
                
                await updateStatus();
                
                if (permission === 'granted') {
                    log('Agora voc√™ pode registrar o push!', 'success');
                }
            } catch (error) {
                log(`Erro: ${error.message}`, 'error');
            }
        }

        // Registrar push
        window.registerPush = async function() {
            try {
                log('Iniciando registro de push...', 'info');

                if (Notification.permission !== 'granted') {
                    log('Permiss√£o n√£o concedida. Solicite primeiro!', 'error');
                    return;
                }

                log('Aguardando Service Worker...', 'info');
                const registration = await navigator.serviceWorker.ready;
                log('Service Worker pronto', 'success');

                log('Verificando subscription existente...', 'info');
                let subscription = await registration.pushManager.getSubscription();

                if (subscription) {
                    log('Subscription j√° existe', 'warning');
                    log(`Endpoint: ${subscription.endpoint.substring(0, 50)}...`, 'info');
                } else {
                    log('Criando nova subscription...', 'info');
                    
                    const applicationServerKey = urlBase64ToUint8Array(VAPID_KEY);
                    subscription = await registration.pushManager.subscribe({
                        userVisibleOnly: true,
                        applicationServerKey: applicationServerKey
                    });

                    log('Subscription criada!', 'success');
                }

                log('Salvando no Firestore...', 'info');
                const subscriptionJSON = subscription.toJSON();
                const subscriptionId = hashString(subscriptionJSON.endpoint);

                await setDoc(doc(db, 'webPushSubscriptions', subscriptionId), {
                    subscription: subscriptionJSON,
                    endpoint: subscriptionJSON.endpoint,
                    platform: 'ios',
                    createdAt: serverTimestamp(),
                    updatedAt: serverTimestamp(),
                    userAgent: navigator.userAgent
                }, { merge: true });

                log(`Salvo com sucesso! ID: ${subscriptionId}`, 'success');
                log('‚úÖ TUDO PRONTO! Aguarde notifica√ß√µes.', 'success');
                
                await updateStatus();

            } catch (error) {
                log(`ERRO: ${error.message}`, 'error');
                console.error(error);
            }
        }

        // Desregistrar push
        window.unregisterPush = async function() {
            try {
                log('Desregistrando push...', 'info');
                
                const registration = await navigator.serviceWorker.ready;
                const subscription = await registration.pushManager.getSubscription();
                
                if (subscription) {
                    await subscription.unsubscribe();
                    log('Subscription removida!', 'success');
                } else {
                    log('Nenhuma subscription encontrada', 'warning');
                }
                
                await updateStatus();
            } catch (error) {
                log(`Erro: ${error.message}`, 'error');
            }
        }

        // Utilit√°rios
        function urlBase64ToUint8Array(base64String) {
            const padding = '='.repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
                .replace(/\-/g, '+')
                .replace(/_/g, '/');

            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);

            for (let i = 0; i < rawData.length; ++i) {
                outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
        }

        function hashString(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'sub_' + Math.abs(hash).toString(36);
        }

        // Inicializar
        log('P√°gina carregada', 'success');
        log('User Agent: ' + navigator.userAgent, 'info');
        updateStatus();
    </script>
</body>
</html>
