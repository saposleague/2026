<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Debug Notifica√ß√µes</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #000;
      color: #0f0;
    }
    .log {
      margin: 5px 0;
      padding: 5px;
      border-left: 3px solid #0f0;
    }
    .error {
      color: #f00;
      border-left-color: #f00;
    }
    button {
      background: #0f0;
      color: #000;
      border: none;
      padding: 10px 20px;
      margin: 10px 5px;
      cursor: pointer;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>üîç Debug Notifica√ß√µes</h1>
  <button onclick="testPermission()">Testar Permiss√£o</button>
  <button onclick="testWebPush()">Testar Web Push</button>
  <button onclick="clearLogs()">Limpar</button>
  <div id="logs"></div>

  <script type="module">
    window.log = function(msg, isError = false) {
      const div = document.createElement('div');
      div.className = 'log' + (isError ? ' error' : '');
      div.textContent = `[${new Date().toLocaleTimeString()}] ${msg}`;
      document.getElementById('logs').appendChild(div);
      console.log(msg);
    };

    window.clearLogs = function() {
      document.getElementById('logs').innerHTML = '';
    };

    window.testPermission = async function() {
      log('üîî Testando permiss√£o...');
      log('Permiss√£o atual: ' + Notification.permission);
      
      if (Notification.permission === 'default') {
        log('Solicitando permiss√£o...');
        const result = await Notification.requestPermission();
        log('Resultado: ' + result);
      }
    };

    window.testWebPush = async function() {
      log('üì± Testando Web Push...');
      
      try {
        if (!('serviceWorker' in navigator)) {
          log('‚ùå Service Worker n√£o dispon√≠vel', true);
          return;
        }
        
        log('‚úÖ Service Worker dispon√≠vel');
        
        const registration = await navigator.serviceWorker.ready;
        log('‚úÖ Service Worker pronto: ' + registration.scope);
        
        if (!('PushManager' in window)) {
          log('‚ùå PushManager n√£o dispon√≠vel', true);
          return;
        }
        
        log('‚úÖ PushManager dispon√≠vel');
        
        const subscription = await registration.pushManager.getSubscription();
        
        if (subscription) {
          log('‚úÖ Subscription existe');
          log('Endpoint: ' + subscription.endpoint.substring(0, 50) + '...');
        } else {
          log('‚ö†Ô∏è Nenhuma subscription encontrada');
          log('Tentando criar subscription...');
          
          try {
            const newSub = await registration.pushManager.subscribe({
              userVisibleOnly: true,
              applicationServerKey: urlBase64ToUint8Array('BOD3066MNR-gYBI6qquZcm2RxlN_ia_dQtADtGZGhan7SeuxcN6T8WwWB0sEnMpWpQ0aS0OkwoItlgYza1MkiRg')
            });
            
            log('‚úÖ Subscription criada!');
            log('Endpoint: ' + newSub.endpoint.substring(0, 50) + '...');
            
            // Tentar salvar
            log('Salvando no Firestore...');
            if (window.webPushIOS) {
              await window.webPushIOS.saveSubscription(newSub);
              log('‚úÖ Salvo com sucesso!');
            } else {
              log('‚ùå webPushIOS n√£o dispon√≠vel', true);
            }
          } catch (error) {
            log('‚ùå Erro ao criar subscription: ' + error.message, true);
          }
        }
        
      } catch (error) {
        log('‚ùå Erro: ' + error.message, true);
        log('Stack: ' + error.stack, true);
      }
    };

    function urlBase64ToUint8Array(base64String) {
      const padding = '='.repeat((4 - base64String.length % 4) % 4);
      const base64 = (base64String + padding)
          .replace(/\-/g, '+')
          .replace(/_/g, '/');

      const rawData = window.atob(base64);
      const outputArray = new Uint8Array(rawData.length);

      for (let i = 0; i < rawData.length; ++i) {
          outputArray[i] = rawData.charCodeAt(i);
      }
      return outputArray;
    }

    // Auto-start
    log('üöÄ Debug iniciado');
    log('User Agent: ' + navigator.userAgent);
    log('Platform: ' + navigator.platform);
    log('Permiss√£o: ' + Notification.permission);
  </script>
  
  <script type="module" src="js/firebase-config.js"></script>
  <script type="module" src="js/web-push-ios.js"></script>
</body>
</html>
